#!/bin/sh
echo "Content-type: text/html"
echo ""
echo '<h3>'
hostname
echo '</h3>'
uptime

echo '<pre>'
env

echo
echo
findmnt

echo
echo

losetup -a
id
echo "pid:$$"
echo "ppid:$PPID"

echo
echo

if [ "$REQUEST_METHOD" = "POST" ]; then
  TMPOUT=/tmp/fwupdate
  PREVIEW=/tmp/fwupdatePreview
  cat - > $TMPOUT

  # Get the line count
  LINES=$(wc -l $TMPOUT | cut -d ' ' -f 1)

  # Remove the first four lines
  tail -$((LINES - 4)) $TMPOUT >$TMPOUT.1

  # Remove the last line
  head -$((LINES - 5)) $TMPOUT.1 >$TMPOUT

  # Copy everything but the new last line to a temporary file
  head -$((LINES - 6)) $TMPOUT >$TMPOUT.1

  # Copy the new last line but remove trailing \r\n
  tail -1 $TMPOUT | perl -p -i -e 's/\r\n$//' >>$TMPOUT.1

  convert -size 145x81 $TMPOUT $PREVIEW

  echo '<img src="/tmp/fwupdatePreview"/>'

fi
echo '</pre>'
